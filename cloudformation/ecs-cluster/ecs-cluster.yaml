AWSTemplateFormatVersion: '2010-09-09'
Description: >
  Editorial Container Cluster
Parameters:
  EcsAmiId:
    Type: String
    Description: >
      Specifies the AMI ID for container instances.
      Default: amazon/amzn-ami-2017.09.d-amazon-ecs-optimized (ami-4cbe0935)
    Default: ami-4cbe0935
  EcsInstanceType:
    Type: CommaDelimitedList
    Description: >
      Specifies the EC2 instance type for your container instances.
      Defaults to t2.small
    Default: t2.small
    ConstraintDescription: must be a valid EC2 instance type.
  KeyName:
    Type: String
    Description: >
      Optional - Specifies the name of an existing Amazon EC2 key pair
      to enable SSH access to the EC2 instances in your cluster.
    Default: team-cms-ec2-ft-tech-editorial-prod
  VpcId:
    Type: String
    Description: >
      Optional - Specifies the ID of an existing VPC in which to launch
      your container instances. If you specify a VPC ID, you must specify a list of
      existing subnets in that VPC. If you do not specify a VPC ID, a new VPC is created
      with atleast 1 subnet.
    Default: vpc-729f2815
    AllowedPattern: "^(?:vpc-[0-9a-f]{8}|)$"
    ConstraintDescription: >
      VPC Id must begin with 'vpc-' or leave blank to have a
      new VPC created
  SubnetIds:
    Type: CommaDelimitedList
    Description: >
      Optional - Specifies the Comma separated list of existing VPC Subnet
      Ids where ECS instances will run
    Default: subnet-cbbc0d82,subnet-3f3fcb64,subnet-a467cfc3
  Sudo:
    Description: Sudo Group to be applied by default
    Type: String
    Default: eng
  SecurityGroupIds:
    Type: CommaDelimitedList
    Description: >
      Comma separated values specifying the Security Group Ids of an existing Security
      Groups. Leave blank to have a new Security Group created
    Default: sg-15be656d,sg-e1875c99
  VpcCidr:
    Type: String
    Description: Optional - Specifies the CIDR Block of VPC
    Default: 10.172.136.0/21
  SubnetCidr1:
    Type: String
    Description: Specifies the CIDR Block of Subnet 1
    Default: 10.172.139.0/24
  SubnetCidr2:
    Type: String
    Description: Specifies the CIDR Block of Subnet 2
    Default: 10.172.140.0/24
  SubnetCidr3:
    Type: String
    Description: Specifies the CIDR Block of Subnet 3
    Default: 10.172.141.0/24
  AsgMaxSize:
    Type: Number
    Description: >
      Specifies the maximum number of instances to scale up in cluster.
      Defaults to 6.
    Default: '6'
  AsgDesiredSize:
    Type: Number
    Description: >
      Specifies the number of instances to launch and register to the cluster.
      Defaults to 3.
    Default: '3'
  IamRoleInstanceProfile:
    Type: String
    Description: >
      Specifies the Name or the Amazon Resource Name (ARN) of the instance
      profile associated with the IAM role for the instance
    Default: arn:aws:iam::307921801440:instance-profile/aws-composer-custom-ecs-global-FTApplicationRoleForECSInstanceRole-ECSInstanceProfile-1Q7D43KYQQN1A
  TagDescription:
    Description: Tag detail for the Description
    Type: String
    Default: Editorial Container Service cluster
  TagEnvironment:
    Description: Tag detail for the Environment
    Type: String
    Default: int
    AllowedValues:
      - 'd'
      - 't'
      - 'p'
      - 'int'
  TagTeamDL:
    Description: Tag detail for the TeamDL
    ConstraintDescription: There must be a valid email address for the TeamDL Topic
    Type: String
    AllowedPattern: ^([a-zA-Z0-9_\-\.]+)@([a-zA-Z0-9_\-\.]+)\.([a-zA-Z]{2,5})$
    Default: team.cms@ft.com
  TagSystemCode:
      Description: SystemCode
      Type: String
      Default: methode
Resources:
  ECSCluster:
    Type: AWS::ECS::Cluster
    Properties:
      ClusterName: !Sub "${AWS::StackName}"
  EcsInstanceLc:
    Type: AWS::AutoScaling::LaunchConfiguration
    Properties:
      ImageId: !Ref EcsAmiId
      InstanceType: !Select [ 0, !Ref EcsInstanceType ]
      AssociatePublicIpAddress: true
      IamInstanceProfile: !Ref IamRoleInstanceProfile
      KeyName: !Ref KeyName
      SecurityGroups: !Ref SecurityGroupIds
      BlockDeviceMappings:
        - DeviceName: "/dev/xvda"
          Ebs:
            VolumeType: "gp2"
            DeleteOnTermination: "true"
            VolumeSize: "10"
      UserData:
        Fn::Base64: !Sub |
         #!/bin/bash
         echo ECS_CLUSTER=${AWS::StackName} >> /etc/ecs/ecs.config
         export PATH=/usr/local/bin:$PATH
         yum -y install jq
         easy_install pip
         pip install --upgrade awscli
         aws configure set default.region ${AWS::Region}
         # HACK: Install package that provides setfacl
         yum -y install acl nmap-ncat
         # Get bootstrap.sh
         aws s3 cp s3://ft-ce-repository/amazon-ftbase/releases/bootstrap.sh .
         # HACK: get the latest Ansible version instead of old v2.1.3
         sed -i 's/ansible==[0-9]*.[0-9]*.[0-9]*/ansible/g' bootstrap.sh
         # HACK: bootstrap.sh assumes aws executable living in /usr/bin but it's not, let's symlink it
         ln -s $(which aws) /usr/bin/aws
         # HACK: bootstrap.sh expects boto package to be installed, let's install it
         pip install --upgrade boto
         # Ready to run bootstrap.sh
         bash ./bootstrap.sh -s ${Sudo} -e ${TagEnvironment}
         # Finally upgrade installed packages
         yum upgrade -y
         # CMS ECS customisation
         aws s3 cp s3://cms-tech-s3/ECS-bootstrap/cms-ecs-bootstrap.sh ./
         bash ./cms-ecs-bootstrap.sh ${TagEnvironment}
  EcsInstanceAsg:
    Type: AWS::AutoScaling::AutoScalingGroup
    DependsOn: ECSCluster
    Properties:
      VPCZoneIdentifier: !Ref SubnetIds
      LaunchConfigurationName: !Ref EcsInstanceLc
      MinSize: 1
      MaxSize: !Ref AsgMaxSize
      DesiredCapacity: !Ref AsgDesiredSize
      Tags:
        -
          Key: Name
          Value: !Sub "ECS Instance - ${AWS::StackName}"
          PropagateAtLaunch: 'true'
        -
          Key: Description
          PropagateAtLaunch: 'true'
          Value:
            Ref: TagDescription
        -
          Key: environment
          PropagateAtLaunch: 'true'
          Value:
            Ref: TagEnvironment
        - Key: teamDL
          PropagateAtLaunch: 'true'
          Value:
            Ref: TagTeamDL
        - Key: systemCode
          PropagateAtLaunch: 'true'
          Value:
            Ref: TagSystemCode
Outputs:
  EcsInstanceAsgName:
    Description: Auto Scaling Group Name for ECS Instances
    Value: !Ref EcsInstanceAsg
  UsedByECSCreateCluster:
    Description: Flag used by EC2 Container Service Create Cluster Wizard
    Value: 'true'
  TemplateVersion:
    Description: The version of the template used by Create Cluster Wizard
    Value: '1.0.0'
